# k8s/postgres-statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata: {name: postgres, namespace: hori}
spec:
  serviceName: "postgres"
  replicas: 1
  selector: {matchLabels: {app: postgres}}
  template:
    metadata: {labels: {app: postgres}}
    spec:
      containers:
      - name: postgres
        image: postgres:16
        env:
        - {name: POSTGRES_PASSWORD, valueFrom: {secretKeyRef: {name: hori-secrets, key: POSTGRES_PASSWORD}}}
        ports: [{containerPort: 5432}]
        volumeMounts: [{name: data, mountPath: /var/lib/postgresql/data}]
  volumeClaimTemplates:
  - metadata: {name: data}
    spec:
      accessModes: ["ReadWriteOnce"]
      resources: {requests: {storage: 5Gi}}
---
apiVersion: v1
kind: Service
metadata: {name: postgres, namespace: hori}
spec:
  clusterIP: None
  selector: {app: postgres}
  ports: [{name: pg, port: 5432, targetPort: 5432}]
